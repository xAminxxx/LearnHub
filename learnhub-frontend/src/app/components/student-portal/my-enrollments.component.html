<div class="container-fluid px-0">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1">
        <i class="bi bi-journal-bookmark text-success me-2"></i>My Enrollments
      </h2>
      <p class="text-secondary mb-0">Track your enrolled courses and progress.</p>
    </div>
    <div class="d-flex gap-2">
      <a routerLink="/student/courses" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Enroll in New Course
      </a>
      <a routerLink="/student/dashboard" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Dashboard
      </a>
    </div>
  </div>

  <!-- Alerts -->
  <div *ngIf="successMessage()" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle me-2"></i>{{ successMessage() }}
    <button type="button" class="btn-close" (click)="successMessage.set('')"></button>
  </div>

  <div *ngIf="errorMessage()" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessage() }}
    <button type="button" class="btn-close" (click)="errorMessage.set('')"></button>
  </div>

  <!-- No Student Profile Warning -->
  <div *ngIf="!loading() && !currentStudent()" class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>Profile Not Found:</strong> Your student profile could not be found. Please contact an administrator.
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-3">Loading your enrollments...</p>
  </div>

  <!-- Stats Cards -->
  <div *ngIf="!loading() && currentStudent()" class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card h-100 border-0 shadow-sm cursor-pointer" 
           [class.border-primary]="activeFilter() === 'ALL'"
           [class.border-2]="activeFilter() === 'ALL'"
           (click)="setFilter('ALL')">
        <div class="card-body text-center py-3">
          <h3 class="fw-bold mb-0 text-dark">{{ stats().total }}</h3>
          <small class="text-muted">Total</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card h-100 border-0 shadow-sm cursor-pointer"
           [class.border-success]="activeFilter() === 'ACTIVE'"
           [class.border-2]="activeFilter() === 'ACTIVE'"
           (click)="setFilter('ACTIVE')">
        <div class="card-body text-center py-3">
          <h3 class="fw-bold mb-0 text-success">{{ stats().active }}</h3>
          <small class="text-muted">Active</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card h-100 border-0 shadow-sm cursor-pointer"
           [class.border-primary]="activeFilter() === 'COMPLETED'"
           [class.border-2]="activeFilter() === 'COMPLETED'"
           (click)="setFilter('COMPLETED')">
        <div class="card-body text-center py-3">
          <h3 class="fw-bold mb-0 text-primary">{{ stats().completed }}</h3>
          <small class="text-muted">Completed</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card h-100 border-0 shadow-sm cursor-pointer"
           [class.border-secondary]="activeFilter() === 'CANCELLED'"
           [class.border-2]="activeFilter() === 'CANCELLED'"
           (click)="setFilter('CANCELLED')">
        <div class="card-body text-center py-3">
          <h3 class="fw-bold mb-0 text-secondary">{{ stats().cancelled }}</h3>
          <small class="text-muted">Cancelled</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Pills -->
  <div *ngIf="!loading() && currentStudent()" class="mb-4">
    <div class="btn-group" role="group">
      <button 
        type="button" 
        class="btn"
        [class.btn-dark]="activeFilter() === 'ALL'"
        [class.btn-outline-dark]="activeFilter() !== 'ALL'"
        (click)="setFilter('ALL')"
      >
        All ({{ stats().total }})
      </button>
      <button 
        type="button" 
        class="btn"
        [class.btn-success]="activeFilter() === 'ACTIVE'"
        [class.btn-outline-success]="activeFilter() !== 'ACTIVE'"
        (click)="setFilter('ACTIVE')"
      >
        Active ({{ stats().active }})
      </button>
      <button 
        type="button" 
        class="btn"
        [class.btn-primary]="activeFilter() === 'COMPLETED'"
        [class.btn-outline-primary]="activeFilter() !== 'COMPLETED'"
        (click)="setFilter('COMPLETED')"
      >
        Completed ({{ stats().completed }})
      </button>
      <button 
        type="button" 
        class="btn"
        [class.btn-secondary]="activeFilter() === 'CANCELLED'"
        [class.btn-outline-secondary]="activeFilter() !== 'CANCELLED'"
        (click)="setFilter('CANCELLED')"
      >
        Cancelled ({{ stats().cancelled }})
      </button>
    </div>
  </div>

  <!-- Enrollments List -->
  <div *ngIf="!loading() && currentStudent()" class="card border-0 shadow-sm">
    <div class="table-responsive" *ngIf="filteredEnrollments().length > 0">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
          <tr>
            <th class="ps-4 py-3">Course</th>
            <th class="py-3">Status</th>
            <th class="py-3">Enrolled Date</th>
            <th class="py-3">Score</th>
            <th class="py-3 text-end pe-4">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let enrollment of filteredEnrollments()">
            <td class="ps-4 py-3">
              <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 text-primary rounded-3 p-2 me-3">
                  <i class="bi bi-book-half"></i>
                </div>
                <div>
                  <h6 class="fw-bold mb-0">{{ enrollment.course?.title || 'Unknown Course' }}</h6>
                  <small class="text-muted">{{ enrollment.courseCode }}</small>
                </div>
              </div>
            </td>
            <td class="py-3">
              <span class="badge" [ngClass]="getStatusBadgeClass(enrollment.status)">
                <i class="bi me-1" [ngClass]="getStatusIcon(enrollment.status)"></i>
                {{ enrollment.status }}
              </span>
            </td>
            <td class="py-3">
              <span class="text-muted">{{ enrollment.enrollmentDate | date:'mediumDate' }}</span>
            </td>
            <td class="py-3">
              <span *ngIf="enrollment.score !== null && enrollment.score !== undefined" class="fw-medium">
                {{ enrollment.score }}%
                <span *ngIf="enrollment.gradeType" class="badge bg-light text-dark border ms-1">
                  {{ enrollment.gradeType }}
                </span>
              </span>
              <span *ngIf="enrollment.score === null || enrollment.score === undefined" class="text-muted">
                -
              </span>
            </td>
            <td class="py-3 text-end pe-4">
              <div class="btn-group">
                <a 
                  [routerLink]="['/student/courses', enrollment.courseId]" 
                  class="btn btn-sm btn-outline-primary"
                  title="View Course"
                >
                  <i class="bi bi-eye"></i>
                </a>
                <button 
                  *ngIf="enrollment.status === 'ACTIVE'"
                  class="btn btn-sm btn-outline-danger"
                  (click)="cancelEnrollment(enrollment)"
                  [disabled]="cancelling() === enrollment.id"
                  title="Cancel Enrollment"
                >
                  <i class="bi bi-x-circle" *ngIf="cancelling() !== enrollment.id"></i>
                  <span class="spinner-border spinner-border-sm" *ngIf="cancelling() === enrollment.id"></span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- No Results -->
    <div *ngIf="filteredEnrollments().length === 0" class="text-center py-5">
      <i class="bi bi-journal-x text-muted" style="font-size: 4rem;"></i>
      <h5 class="mt-3 text-muted">No enrollments found</h5>
      <p class="text-muted" *ngIf="activeFilter() === 'ALL'">
        You haven't enrolled in any courses yet.
      </p>
      <p class="text-muted" *ngIf="activeFilter() !== 'ALL'">
        No {{ activeFilter().toLowerCase() }} enrollments found.
      </p>
      <a routerLink="/student/courses" class="btn btn-primary mt-2" *ngIf="activeFilter() === 'ALL'">
        <i class="bi bi-search me-2"></i>Browse Courses
      </a>
      <button class="btn btn-outline-secondary mt-2" (click)="setFilter('ALL')" *ngIf="activeFilter() !== 'ALL'">
        View All Enrollments
      </button>
    </div>
  </div>

  <!-- Notes Section -->
  <div *ngIf="!loading() && currentStudent() && filteredEnrollments().length > 0" class="mt-4">
    <div class="card border-0 bg-light">
      <div class="card-body py-3">
        <div class="d-flex align-items-center">
          <i class="bi bi-info-circle text-primary me-2"></i>
          <small class="text-muted">
            <strong>Tip:</strong> You can cancel active enrollments if you change your mind. Completed enrollments cannot be modified.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
